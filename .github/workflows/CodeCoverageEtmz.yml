# This workflow will build a Swift project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift

name: CodeCoverageEtmz

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      message:
        description: 'JSON message'
        required: true
      prnumber:
        description: 'PR number string'
        required: true
permissions:
  pull-requests: write      

jobs:
  example_comment_pr:
    runs-on: ubuntu-latest
    name: An example job to comment a PR
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 100

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1

      - name: Install dependencies
        run: gem install bundler
      - name: Install Fastlane
        run: bundle install
      
      - name: Save message to file
        run: echo "${{ github.event.inputs.message }}" > fastlane/xcov_output/index.json


      - name: Run Fastlane
        run: bundle exec fastlane custom_lane_danger token:${{ secrets.GITHUB_TOKEN }} pr:${{ github.event.inputs.prnumber }}

  danger:
    runs-on: ubuntu-latest
    # if: github.event_name  == 'pull_request' # if only run pull request when multiple trigger workflow
    steps:
    - uses: actions/checkout@v4
    - uses: actions/cache@v4
      with:
        path: vendor/bundle
        key: ${{ runner.os }}-gems-${{ hashFiles('Gemfile') }} # change your gemfile path
        restore-keys: |
          ${{ runner.os }}-gems-
    - uses: MeilCli/danger-action@v6
      with:
        danger_file: 'Dangerfile'
        danger_id: 'danger-pr'
      env:
        DANGER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}

